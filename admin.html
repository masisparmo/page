<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Isparmo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: { colors: { brand: { dark: '#0f172a' } } }
            }
        }
    </script>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-100 min-h-screen">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-xl w-full max-w-sm border border-slate-200 dark:border-slate-700">
            <h2 class="text-2xl font-bold mb-6 text-center">Admin Login</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-2 rounded-lg border dark:bg-slate-700 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-2 rounded-lg border dark:bg-slate-700 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    <i class="fas fa-sign-in-alt mr-2"></i> Masuk
                </button>
            </form>
            <div class="mt-4 text-center">
                <button onclick="openForgot()" class="text-sm text-blue-500 hover:underline">Lupa Password?</button>
            </div>
            <p id="login-error" class="text-red-500 text-sm mt-4 text-center hidden"></p>
        </div>
    </div>

    <!-- FORGOT PASSWORD MODAL -->
    <div id="forgot-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-xl w-full max-w-sm p-6">
            <h3 class="text-xl font-bold mb-4">Reset Password</h3>
            <p class="text-sm text-slate-500 mb-4">Masukkan username Anda. Password baru akan dikirim ke email yang terdaftar.</p>
            <form id="forgot-form" class="space-y-3">
                <input type="text" name="forgot_username" placeholder="Username" class="input-field" required>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="closeForgot()" class="px-4 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">Batal</button>
                    <button type="submit" class="btn-primary">Kirim</button>
                </div>
            </form>
        </div>
    </div>

    <!-- DASHBOARD SCREEN -->
    <div id="dashboard-screen" class="hidden">
        <!-- Navbar -->
        <nav class="bg-white dark:bg-slate-800 shadow-md p-4 sticky top-0 z-50">
            <div class="max-w-4xl mx-auto flex justify-between items-center">
                <h1 class="font-bold text-xl">Admin Dashboard</h1>
                <button onclick="logout()" class="text-red-500 hover:text-red-600 font-medium text-sm">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </nav>

        <div class="max-w-4xl mx-auto p-4 mt-6">

            <!-- TABS -->
            <div class="flex gap-2 mb-6 border-b border-slate-200 dark:border-slate-700 overflow-x-auto">
                <button onclick="switchTab('profile')" id="tab-btn-profile" class="tab-btn px-4 py-2 border-b-2 border-blue-500 font-medium text-blue-600">Profile</button>
                <button onclick="switchTab('socials')" id="tab-btn-socials" class="tab-btn px-4 py-2 border-b-2 border-transparent text-slate-500 hover:text-slate-700">Socials</button>
                <button onclick="switchTab('apps')" id="tab-btn-apps" class="tab-btn px-4 py-2 border-b-2 border-transparent text-slate-500 hover:text-slate-700">Apps</button>
            </div>

            <!-- TAB CONTENT: PROFILE -->
            <div id="tab-profile" class="tab-content">
                <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm p-6">
                    <h2 class="text-lg font-bold mb-4">Edit Profile</h2>
                    <form id="profile-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Nama</label>
                            <input type="text" name="profile_name" class="w-full input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Title / Bio Singkat</label>
                            <input type="text" name="profile_title" class="w-full input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">URL Foto Profil</label>
                            <input type="text" name="profile_image" class="w-full input-field">
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" name="verified_badge" id="verified_badge" class="w-4 h-4">
                            <label for="verified_badge" class="text-sm">Tampilkan Centang Biru</label>
                        </div>
                        <button type="submit" class="btn-primary">Simpan Perubahan</button>
                    </form>
                </div>
            </div>

            <!-- TAB CONTENT: SOCIALS -->
            <div id="tab-socials" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">Daftar Social Media</h2>
                    <button onclick="openModal('social')" class="btn-primary text-sm"><i class="fas fa-plus mr-1"></i> Tambah</button>
                </div>
                <div id="socials-list" class="space-y-3">
                    <!-- Items injected here -->
                </div>
            </div>

            <!-- TAB CONTENT: APPS -->
            <div id="tab-apps" class="tab-content hidden">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">Daftar Aplikasi / Link</h2>
                    <button onclick="openModal('app')" class="btn-primary text-sm"><i class="fas fa-plus mr-1"></i> Tambah</button>
                </div>
                <div id="apps-list" class="space-y-3">
                    <!-- Items injected here -->
                </div>
            </div>

        </div>
    </div>

    <!-- MODAL FORM (Reusable) -->
    <div id="modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-xl w-full max-w-md p-6">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Edit Item</h3>
            <form id="modal-form" class="space-y-3">
                <input type="hidden" name="id">
                <input type="hidden" name="type"> <!-- 'social' or 'app' -->

                <!-- Dynamic Fields -->
                <div id="modal-fields"></div>

                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700">Batal</button>
                    <button type="submit" class="btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        .input-field {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
            background-color: #fff;
            width: 100%;
        }
        .dark .input-field {
            background-color: #334155;
            border-color: #475569;
            color: #fff;
        }
        .btn-primary {
            background-color: #2563eb;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary:hover { background-color: #1d4ed8; }
    </style>

    <script type="module">
        import { fetchData, login, forgotPassword, updateProfile, crudSocial, crudApp, reorderItems } from './js/api.js';
        import { ICONS } from './js/icons.js';

        // --- GLOBAL STATE ---
        let currentData = null;

        // --- AUTH ---
        window.logout = () => {
            sessionStorage.removeItem('admin_token');
            window.location.reload();
        };

        const checkAuth = () => {
            if (sessionStorage.getItem('admin_token')) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard-screen').classList.remove('hidden');
                loadDashboard();
            }
        };

        // --- EVENT LISTENERS ---
        document.getElementById('login-form').onsubmit = async (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;

            const res = await login(u, p);
            if (res.success) {
                sessionStorage.setItem('admin_token', res.token);
                checkAuth();
            } else {
                const err = document.getElementById('login-error');
                err.innerText = res.message;
                err.classList.remove('hidden');
            }
        };

        document.getElementById('forgot-form').onsubmit = async (e) => {
            e.preventDefault();
            const u = e.target.elements['forgot_username'].value;
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;

            btn.innerText = "Mengirim...";
            btn.disabled = true;

            const res = await forgotPassword(u);
            if (res.success) {
                alert("Email reset password telah dikirim (jika username valid). Cek inbox/spam folder Anda.");
                closeForgot();
            } else {
                alert("Gagal: " + res.message);
            }

            btn.innerText = originalText;
            btn.disabled = false;
        };

        window.openForgot = () => {
            document.getElementById('forgot-modal').classList.remove('hidden');
        };

        window.closeForgot = () => {
            document.getElementById('forgot-modal').classList.add('hidden');
        };

        document.getElementById('profile-form').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {};
            formData.forEach((value, key) => data[key] = value);
            // Handle checkbox manually
            data.verified_badge = document.getElementById('verified_badge').checked;

            if(confirm("Simpan perubahan profil?")) {
                await updateProfile(data);
                alert("Profil diperbarui!");
                loadDashboard(); // Refresh data
            }
        };

        document.getElementById('modal-form').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const type = formData.get('type');
            const id = formData.get('id');
            const operation = id ? 'update' : 'create';

            const item = {};
            formData.forEach((value, key) => item[key] = value);

            // Map keys back to match DB schema (Uppercase first letter typically in our mock/sheet)
            // But let's check field names.
            // In Modal generation we used lowercase names for input name attribute.
            // We need to map them to Capitalized keys for the API/Sheet.

            const cleanItem = {
                ID: id || undefined,
                Visible: item.visible === 'on' || item.visible === 'true' // Checkbox value
            };

            if (type === 'social') {
                cleanItem.Platform = item.platform;
                cleanItem.Url = item.url;
                cleanItem.IconClass = item.iconclass;
                await crudSocial(operation, cleanItem);
            } else {
                cleanItem.Name = item.name;
                cleanItem.Description = item.description;
                cleanItem.Url = item.url;
                cleanItem.IconClass = item.iconclass;
                cleanItem.ColorTheme = item.colortheme;
                cleanItem.Password = item.password; // Save password

                // DEBUG: Alert payload to verify password is being sent
                if (cleanItem.Password) {
                    alert("DEBUG Client: Mengirim password: " + cleanItem.Password);
                } else {
                    alert("DEBUG Client: Password kosong/tidak dikirim.");
                }

                await crudApp(operation, cleanItem);
            }

            closeModal();
            loadDashboard();
        };

        // --- DASHBOARD FUNCTIONS ---
        async function loadDashboard() {
            currentData = await fetchData();
            if (!currentData) return;

            // Check if we got Admin data (look for a known field like Password in apps if any exist)
            // Or simpler: Check if any app has isLocked=true (which means it was sanitized)
            const hasSanitizedApps = currentData.apps.some(app => app.isLocked === true);
            if (hasSanitizedApps) {
                alert("Sesi Admin Anda kedaluwarsa atau tidak valid. Data tidak dimuat sepenuhnya. Silakan Logout dan Login kembali.");
                logout();
                return;
            }

            // Fill Profile Form
            const p = currentData.config;
            const form = document.getElementById('profile-form');
            form.elements['profile_name'].value = p.profile_name || '';
            form.elements['profile_title'].value = p.profile_title || '';
            form.elements['profile_image'].value = p.profile_image || '';
            form.elements['verified_badge'].checked = String(p.verified_badge) === 'true';

            // Fill Lists
            renderList('socials-list', currentData.socials, 'social');
            renderList('apps-list', currentData.apps, 'app');

            // Initialize Sortable for Apps only (as requested)
            initSortable('apps-list', 'app');
        }

        function renderList(containerId, items, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            items.forEach(item => {
                const el = document.createElement('div');
                el.className = "flex items-center justify-between p-3 bg-white dark:bg-slate-700 rounded-lg shadow-sm border border-slate-100 dark:border-slate-600 group-item";
                el.setAttribute('data-id', item.ID); // Crucial for sorting

                const title = type === 'social' ? item.Platform : item.Name;
                const visible = String(item.Visible).toLowerCase() === 'true';

                // Add grip handle only for apps (since we enable sortable there)
                const grip = type === 'app' ? '<i class="fas fa-grip-vertical text-slate-400 mr-3 cursor-move handle"></i>' : '';

                el.innerHTML = `
                    <div class="flex items-center">
                        ${grip}
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded bg-slate-100 dark:bg-slate-600 flex items-center justify-center">
                                <i class="${item.IconClass}"></i>
                            </div>
                            <div>
                                <p class="font-medium">${title}</p>
                                <p class="text-xs text-slate-500 truncate max-w-[200px]">${item.Url}</p>
                            </div>
                            ${!visible ? '<span class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded ml-2">Hidden</span>' : ''}
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.editItem('${type}', '${item.ID}')" class="text-blue-500 hover:bg-blue-50 p-2 rounded"><i class="fas fa-edit"></i></button>
                        <button onclick="window.deleteItem('${type}', '${item.ID}')" class="text-red-500 hover:bg-red-50 p-2 rounded"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function initSortable(containerId, type) {
            const el = document.getElementById(containerId);
            if (!el) return;

            // Prevent duplicate initialization
            if(el.sortable) el.sortable.destroy();

            el.sortable = new Sortable(el, {
                handle: '.handle', // Drag handle selector
                animation: 150,
                onEnd: async function (evt) {
                    const ids = Array.from(el.children).map(child => child.getAttribute('data-id'));
                    console.log("New Order:", ids);

                    // Call API to save order
                    const res = await reorderItems(type, ids);
                    if (!res.success) {
                        alert("Gagal menyimpan urutan: " + res.message);
                        // Revert? For now, just reload dashboard to sync state
                        loadDashboard();
                    }
                }
            });
        }

        // --- EXPORTED TO WINDOW (For HTML onclick) ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('border-blue-500', 'text-blue-600');
                el.classList.add('border-transparent', 'text-slate-500');
            });

            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            const btn = document.getElementById(`tab-btn-${tab}`);
            btn.classList.remove('border-transparent', 'text-slate-500');
            btn.classList.add('border-blue-500', 'text-blue-600');
        };

        window.openModal = (type, id = null) => {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const fields = document.getElementById('modal-fields');
            const form = document.getElementById('modal-form');

            form.reset();
            form.elements['type'].value = type;
            form.elements['id'].value = id || '';

            title.innerText = id ? `Edit ${type}` : `Tambah ${type}`;

            // Populate fields based on type
            let html = '';
            if (type === 'social') {
                html += createInput('Platform', 'platform', 'text', 'e.g. Facebook');
                html += createInput('URL', 'url', 'text', 'https://...');
                html += createIconPicker('FontAwesome Class', 'iconclass');
            } else {
                html += createInput('Nama Aplikasi', 'name', 'text');
                html += createInput('Deskripsi', 'description', 'text');
                html += createInput('URL', 'url', 'text');
                html += createIconPicker('FontAwesome Class', 'iconclass');
                html += createInput('Warna Tema', 'colortheme', 'text', 'blue, purple, pink');
                html += createInput('Password (Opsional)', 'password', 'text', 'Kosongkan jika tidak dikunci');
            }

            // Visible Checkbox
            html += `
                <div class="flex items-center gap-2 mt-4">
                    <input type="checkbox" name="visible" id="visible-check" class="w-4 h-4" checked>
                    <label for="visible-check" class="text-sm">Tampilkan</label>
                </div>
            `;

            fields.innerHTML = html;

            // Initialize Custom Icon Logic
            setupIconPicker();

            // Fill values if editing
            if (id && currentData) {
                const collection = type === 'social' ? currentData.socials : currentData.apps;
                const item = collection.find(x => x.ID === id);
                if (item) {
                    if (type === 'social') {
                        form.elements['platform'].value = item.Platform;
                        form.elements['url'].value = item.Url;
                        form.elements['iconclass'].value = item.IconClass;
                    } else {
                        form.elements['name'].value = item.Name;
                        form.elements['description'].value = item.Description;
                        form.elements['url'].value = item.Url;
                        form.elements['iconclass'].value = item.IconClass;
                        form.elements['colortheme'].value = item.ColorTheme;
                        form.elements['password'].value = item.Password || '';
                    }
                    // Update visual state of picker
                    updateIconPickerVisual(item.IconClass);

                    if (document.getElementById('visible-check')) {
                        document.getElementById('visible-check').checked = String(item.Visible).toLowerCase() === 'true';
                    }
                }
            } else {
                 updateIconPickerVisual('fas fa-circle'); // Default
            }

            modal.classList.remove('hidden');
        };

        window.closeModal = () => {
            document.getElementById('modal').classList.add('hidden');
        };

        function createIconPicker(label, name) {
            return `
                <div class="mt-2 relative">
                    <label class="block text-sm font-medium mb-1 capitalize">${label}</label>
                    <div class="relative">
                        <input type="text" name="${name}" id="icon-input" class="input-field !pl-12" placeholder="Pilih atau ketik icon..." autocomplete="off">
                        <div id="icon-preview" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-500 text-lg">
                            <i class="fas fa-search"></i>
                        </div>
                        <button type="button" id="icon-dropdown-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <!-- Dropdown Content -->
                    <div id="icon-dropdown" class="hidden absolute z-50 w-full mt-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg shadow-xl max-h-60 overflow-y-auto">
                        <div class="grid grid-cols-4 gap-2 p-2" id="icon-grid">
                            <!-- Icons injected here -->
                        </div>
                    </div>
                </div>
            `;
        }

        function setupIconPicker() {
            const input = document.getElementById('icon-input');
            const dropdown = document.getElementById('icon-dropdown');
            const grid = document.getElementById('icon-grid');
            const btn = document.getElementById('icon-dropdown-btn');

            // Populate Grid
            grid.innerHTML = ICONS.map(icon => `
                <button type="button" class="flex flex-col items-center justify-center p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors gap-1 text-center"
                    onclick="window.selectIcon('${icon.class}')" title="${icon.label}">
                    <i class="${icon.class} text-xl text-slate-700 dark:text-slate-200"></i>
                    <span class="text-[10px] text-slate-500 dark:text-slate-400 truncate w-full">${icon.label}</span>
                </button>
            `).join('');

            // Toggle Dropdown
            const toggle = () => dropdown.classList.toggle('hidden');
            input.addEventListener('click', toggle);
            btn.addEventListener('click', toggle);

            // Filter on type
            input.addEventListener('input', (e) => {
                const val = e.target.value.toLowerCase();
                // Update preview live
                updateIconPickerVisual(e.target.value);

                // Filter Grid
                const buttons = grid.querySelectorAll('button');
                let hasMatch = false;
                buttons.forEach(btn => {
                    const title = btn.getAttribute('title').toLowerCase();
                    const cls = btn.getAttribute('onclick').toLowerCase(); // hacky but works
                    if (title.includes(val) || cls.includes(val)) {
                        btn.classList.remove('hidden');
                        hasMatch = true;
                    } else {
                        btn.classList.add('hidden');
                    }
                });
                if(val && hasMatch) dropdown.classList.remove('hidden');
            });

            // Close on click outside
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target) && !btn.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });
        }

        window.selectIcon = (iconClass) => {
            const input = document.getElementById('icon-input');
            input.value = iconClass;
            updateIconPickerVisual(iconClass);
            document.getElementById('icon-dropdown').classList.add('hidden');
        };

        function updateIconPickerVisual(iconClass) {
            const preview = document.getElementById('icon-preview');
            // Remove 'fa-search' or old icon
            preview.innerHTML = `<i class="${iconClass}"></i>`;
        }

        window.editItem = (type, id) => {
            openModal(type, id);
        };

        window.deleteItem = async (type, id) => {
            if (confirm("Yakin ingin menghapus item ini?")) {
                if (type === 'social') await crudSocial('delete', { ID: id });
                else await crudApp('delete', { ID: id });
                loadDashboard();
            }
        };

        function createInput(label, name, type, placeholder = '') {
            return `
                <div class="mt-2">
                    <label class="block text-sm font-medium mb-1 capitalize">${label}</label>
                    <input type="${type}" name="${name}" placeholder="${placeholder}" class="input-field">
                </div>
            `;
        }

        // Init
        checkAuth();

    </script>
</body>
</html>
